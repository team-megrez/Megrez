on_actions = {
	on_startup = {
		effect = {
			set_variable = { global.china_target_tag = QIE }
			for_each_scope_loop = {
				array = global.china_tags_array
				every_unit_leader = { set_character_flag = CHI_original_unit_leader }

				#integration setup
				LEC = { enable_coring_at_fifty_compliance = yes }
				TAI = { enable_coring_at_fifty_compliance = yes }

				if = {
					limit = { original_tag = SIK }
					for_each_scope_loop = {
						array = global.china_tags_array
						if = {
							limit = { NOT = { original_tag = PREV } }
							enable_coring_at_fifty_compliance = yes
						}
					}
					KUM = { enable_coring_at_fifty_compliance = yes }
				}
				else = {
					for_each_scope_loop = {
						array = global.china_tags_array
						if = {
							limit = {
								NOT = { original_tag = SIK }
								NOT = { original_tag = PREV }
							}
							enable_coring_at_fifty_compliance = yes
							PREV = { enable_coring_at_fifty_compliance = yes }
						}
					}
				}
				XSM = {
					SIK = { enable_coring_at_fifty_compliance = yes }
					KUM = { enable_coring_at_fifty_compliance = yes }
				}
				KUM = {
					SIK = { enable_coring_at_fifty_compliance = yes }
				}
			}
			every_state = {
				limit = { is_core_china = yes }
				for_each_scope_loop = {
					array = global.china_tags_array
					PREV = { enable_state_integration_50_compliance = yes }
				}
			}

			# Initialise government ambition areas (so that they are separate from their 'default' ambitions)
			FNG = { set_potential_national_government = yes }
			QIE = { set_potential_national_government = yes }

			# Initialise resource decisions for Chinese tags
			QIE = {
				china_setup_resources_decisions = yes
				set_temp_variable = { coalition_partner_var = token:paternal_autocrat }
				add_to_coalition = yes
			}

			# Make GXC and HNN puppets of LEP (doesn't work from history file)
			GXC = { get_current_government_type = yes }
			HNN = { get_current_government_type = yes }
			LEP = {
				set_autonomy = {
					target = GXC
					autonomy_state = kr_associated_governorate
				}
				set_autonomy = {
					target = HNN
					autonomy_state = kr_associated_governorate
				}
				add_ai_strategy = {
					type = diplo_action_desire
					id = GXC
					target = call_allies
					value = -99999
				}
				add_ai_strategy = {
					type = diplo_action_acceptance
					id = GXC
					target = join_allies
					value = -99999
				}
				add_ai_strategy = {
					type = diplo_action_desire
					id = HNN
					target = call_allies
					value = -99999
				}
				add_ai_strategy = {
					type = diplo_action_acceptance
					id = HNN
					target = join_allies
					value = -99999
				}
			}
			GXC = {
				restore_previous_government_type = yes
				add_ai_strategy = {
					type = diplo_action_desire
					id = LEP
					target = join_allies
					value = -99999
				}
				add_ai_strategy = {
					type = diplo_action_acceptance
					id = LEP
					target = call_allies
					value = -99999
				}
			}
			HNN = {
				restore_previous_government_type = yes
				add_ai_strategy = {
					type = diplo_action_desire
					id = LEP
					target = join_allies
					value = -99999
				}
				add_ai_strategy = {
					type = diplo_action_acceptance
					id = LEP
					target = call_allies
					value = -99999
				}
			}
			# Initiate starting coalitions
			SHX = {
				set_temp_variable = { coalition_partner_var = token:market_liberal }
				add_to_coalition = yes
				set_temp_variable = { coalition_partner_var = token:social_conservative }
				add_to_coalition = yes
				set_temp_variable = { coalition_partner_var = token:authoritarian_democrat }
				add_to_coalition = yes
				set_temp_variable = { coalition_partner_var = token:national_populist }
				add_to_coalition = yes
			}
			GXC = {
				set_temp_variable = { coalition_partner_var = token:social_democrat }
				add_to_coalition = yes
				set_temp_variable = { coalition_partner_var = token:market_liberal }
				add_to_coalition = yes
			}
			HNN = {
				set_temp_variable = { coalition_partner_var = token:authoritarian_democrat }
				add_to_coalition = yes
			}

			#Initialise state flags
			326 = { set_state_flag = guangdong_province_state } #Hong Kong
			591 = { set_state_flag = guangdong_province_state } #Qiongya
			592 = { set_state_flag = guangdong_province_state } #Guangzhou
			593 = { set_state_flag = guangdong_province_state } #Yuehai
			728 = { set_state_flag = guangdong_province_state } #Guangzhouwan
			729 = { set_state_flag = guangdong_province_state } #Macau
			800 = { set_state_flag = guangdong_province_state } #Shaoguan
			801 = { set_state_flag = guangdong_province_state } #Shantou
			1012 = { set_state_flag = guangdong_province_state } #Chaoxun
			1056 = { set_state_flag = guangdong_province_state } #Qinlian

			594 = { set_state_flag = guangxi_province_state } #Nanning
			599 = { set_state_flag = guangxi_province_state } #Guilin
			1053 = { set_state_flag = guangxi_province_state } #Zhennan
			1054 = { set_state_flag = guangxi_province_state } #Tiannan
			1055 = { set_state_flag = guangxi_province_state } #Liujiang

			608 = { set_state_flag = zhili_province_state } #Jingzhao
			609 = { set_state_flag = zhili_province_state } #Tianjin
			614 = { set_state_flag = zhili_province_state } #Tangshan
			1061 = { set_state_flag = zhili_province_state } #Daming
			1062 = { set_state_flag = zhili_province_state } #Baoding
			1063 = { set_state_flag = zhili_province_state } #Cangzhou

			607 = { set_state_flag = henan_province_state } #Heluo
			1058 = { set_state_flag = henan_province_state } #Ruyang
			1059 = { set_state_flag = henan_province_state } #Kaifeng
			1060 = { set_state_flag = henan_province_state } #Hebi

			620 = { set_state_flag = hubei_province_state } #Xiangyang
			1048 = { set_state_flag = hubei_province_state } #Wuhan
			1049 = { set_state_flag = hubei_province_state } #Shihe

			602 = { set_state_flag = hunan_province_state } #Xiangjiang
			1013 = { set_state_flag = hunan_province_state } #Chenyuan

			598 = { set_state_flag = jiangsu_province_state } #Huaiyang
			613 = { set_state_flag = jiangsu_province_state } #Jinling
			743 = { set_state_flag = jiangsu_province_state } #Shanghai
			1047 = { set_state_flag = jiangsu_province_state } #Xuhai
			1075 = { set_state_flag = jiangsu_province_state } #Nantong

			600 = { set_state_flag = jiangxi_province_state } #Gannan
			1044 = { set_state_flag = jiangxi_province_state } #Yuzhang
			1045 = { set_state_flag = jiangxi_province_state } #Xuyang

			622 = { set_state_flag = shaanxi_province_state } #Yulin
			799 = { set_state_flag = shaanxi_province_state } #Guanzhong

			615 = { set_state_flag = shanxi_province_state } #Eastern Shanxi
			1072 = { set_state_flag = shanxi_province_state } #Central Shanxi

			597 = { set_state_flag = shandong_province_state } #Jinan
			744 = { set_state_flag = shandong_province_state } #Qingdao
			996 = { set_state_flag = shandong_province_state } #Weihaiwei
			1064 = { set_state_flag = shandong_province_state } #Linyi
			1065 = { set_state_flag = shandong_province_state } #Jiaodong

			606 = { set_state_flag = anhui_province_state } #Anqing
			1014 = { set_state_flag = anhui_province_state } #Wuhu
			1050 = { set_state_flag = anhui_province_state } #Huaisi

			596 = { set_state_flag = zhejiang_province_state } #Qiantang
			746 = { set_state_flag = zhejiang_province_state } #Ningbo
			803 = { set_state_flag = zhejiang_province_state } #Wenzhou
			1067 = { set_state_flag = zhejiang_province_state } #Jinhua
			1068 = { set_state_flag = zhejiang_province_state } #Kuaiji
			1069 = { set_state_flag = zhejiang_province_state } #Lishui

			595 = { set_state_flag = fujian_province_state } #Jian'an
			747 = { set_state_flag = fujian_province_state } #Fuzhou
			802 = { set_state_flag = fujian_province_state } #Xiamen
			1046 = { set_state_flag = fujian_province_state } #Tingzhang
			1066 = { set_state_flag = fujian_province_state } #Minhou

			601 = { set_state_flag = sichuan_province_state } #Xikang
			605 = { set_state_flag = sichuan_province_state } #Chengdu
			650 = { set_state_flag = sichuan_province_state } #Chongqing
			661 = { set_state_flag = sichuan_province_state } #Daxian
			788 = { set_state_flag = sichuan_province_state } #Aba
			1015 = { set_state_flag = sichuan_province_state } #Liangshan

			603 = { set_state_flag = guizhou_province_state } #Qiangzhong
			1051 = { set_state_flag = guizhou_province_state } #Guixi
			1052 = { set_state_flag = guizhou_province_state } #Zhenyuan

			325 = { set_state_flag = yunnan_province_state } #Kunming
			816 = { set_state_flag = yunnan_province_state } #Dali

			353 = { set_state_flag = qinghai_province_state } #Xining
			604 = { set_state_flag = qinghai_province_state } #Yushu

			283 = { set_state_flag = gansu_province_state } #Lanzhou
			774 = { set_state_flag = gansu_province_state } #Hexi Corridor

			348 = { set_state_flag = ningxia_province_state } #Ningxia

			328 = { set_state_flag = fengtian_province_state } #Andong
			715 = { set_state_flag = fengtian_province_state } #Liaobei
			716 = { set_state_flag = fengtian_province_state } #Liaoning
			745 = { set_state_flag = fengtian_province_state } #Kwantung

			717 = { set_state_flag = jilin_province_state } #Hejiang
			885 = { set_state_flag = jilin_province_state } #Songjiang
			886 = { set_state_flag = jilin_province_state } #Jilin
			408 = { set_state_flag = jilin_province_state } #Vladivostok
			409 = { set_state_flag = jilin_province_state } #Khabarovsk
			537 = { set_state_flag = jilin_province_state } #Sakhalin

			714 = { set_state_flag = heilongjiang_province_state } #Nenjiang
			883 = { set_state_flag = heilongjiang_province_state } #Heilongjiang
			884 = { set_state_flag = heilongjiang_province_state } #Xing'an
			560 = { set_state_flag = heilongjiang_province_state } #Nikolayevsk
			561 = { set_state_flag = heilongjiang_province_state } #Amur
			657 = { set_state_flag = heilongjiang_province_state } #Blagoveshchensk

			610 = { set_state_flag = jehol_province_state } #Jehol

			621 = { set_state_flag = suiyuan_province_state } #Ulanqab
			616 = { set_state_flag = suiyuan_province_state } #Ordos

			611 = { set_state_flag = chahar_province_state } #Chahar
			612 = { set_state_flag = chahar_province_state } #Xilingol

			287 = { set_state_flag = xinjiang_province_state } #Hotan
			617 = { set_state_flag = xinjiang_province_state } #Dihua
			618 = { set_state_flag = xinjiang_province_state } #Dzungaria
			619 = { set_state_flag = xinjiang_province_state } #Kashgar
			897 = { set_state_flag = xinjiang_province_state } #Aksai Chin
			1083 = { set_state_flag = xinjiang_province_state } #Kumul
			1085 = { set_state_flag = xinjiang_province_state } #Taklamakan Desert

			524 = { set_state_flag = taiwan_province_state } #Taiwan

			CHI = { become_exiled_in = { target = FRA legitimacy = 10 } }
		}
	}

	#ROOT is winner #FROM gets annexed - For civil wars on_civil_war_end is also fired
	on_annex = {
		effect = {
			# Disable Mantetsu for Japan if Fengtian is annexed & Remove Zhang-exclusive ideas
			if = {
				limit = {
					FROM = { tag = FNG }
				}
				JAP = {
					if = {
						limit = { has_idea = FNG_mantetsu_profits }
						remove_ideas = FNG_mantetsu_profits
						if = {
							limit = {
								has_dynamic_modifier = { modifier = FNG_mantetsu_profits_modifier scope = FNG }
							}
							remove_dynamic_modifier = { modifier = FNG_mantetsu_profits_modifier }
						}
						add_timed_idea = {
							idea = JAP_MANTETSU_COLLAPSE
							days = 235
						}
					}
				}
				FNG = {
					if = {
						limit = { has_dynamic_modifier = { modifier = FNG_factionalism_modifier } }
						remove_dynamic_modifier = { modifier = FNG_factionalism_modifier }
					}
				}
			}

			# Move the holder of the British vote
			if = {
				limit = {
					FROM = {
						tag = AST
						OR = {
							has_country_flag = legation_council_member
							has_country_flag = legation_council_vote
						}
					}
					OR = {
						GBR = { is_faction_leader = yes }
						CAN = { is_faction_leader = yes }
					}
				}
				if = {
					limit = {
						GBR = { is_faction_leader = yes }
					}
					GBR = { save_event_target_as = new_holder }
				}
				else = {
					CAN = { save_event_target_as = new_holder }
				}
				event_target:new_holder = {
					if = {
						limit = { FROM = { has_country_flag = legation_council_vote } }
						LEC_add_to_legation_council = yes
					}
					else = {
						LEC_add_to_legation_council_observer = yes
					}
					if = {
						limit = { has_country_flag = AST_hong_kong }
						clr_country_flag = AST_hong_kong
						event_target:new_holder = { set_country_flag = AST_hong_kong }
					}
				}
				FROM = {
					if = {
						limit = { has_country_flag = AST_hong_kong }
						clr_country_flag = AST_hong_kong
						event_target:new_holder = { set_country_flag = AST_hong_kong }
					}
					if = {
						limit = { has_country_flag = legation_council_vote }
						save_event_target_as = LEC_AST_had_vote
					}
					LEC_remove_from_legation_council = yes
				}
				event_target:new_holder = { country_event = lecbrits.29 }
			}

			# Remove from Legation Council
			if = {
				limit = {
					FROM = { has_country_flag = legation_council_member }
				}
				if = {
					limit = {
						FROM = { tag = BEL }
						country_exists = LEC
					}
					LEC = {
						country_event = { id = lec.48 days = 3 random_hours = 168 }
					}
				}
				else = {
					FROM = { LEC_remove_from_legation_council = yes }
				}
			}

			#Move the China target
			if = {
				limit = {
					FROM = { tag = CHN }
				}
				find_next_chinese_target = yes
			}

			#Disable Legation Council
			if = {
				limit = {
					FROM = { tag = LEC }
				}
				every_other_country = {
					limit = { has_country_flag = legation_council_member }
					country_event = lec.106
				}
			}

			#Disable Mantetsu
			else_if = {
				limit = {
					FROM = { tag = FNG }
				}
				JAP = {
					remove_ideas = FNG_mantetsu_profits
					if = {
						limit = {
							has_dynamic_modifier = { modifier = FNG_mantetsu_profits_modifier scope = FNG }
						}
						remove_dynamic_modifier = { modifier = FNG_mantetsu_profits_modifier }
					}
				}
			}

			# Remove Qing's German influence
			else_if = {
				limit = {
					FROM = { tag = GER }
				}
				QIE = {
					if = {
						limit = {
							has_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
						}
						clear_variable = var_PEKCOM_influence
						remove_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
						set_political_party = {
							ideology = market_liberal
							popularity = 0
						}
					}
				}
			}

			# Remove the AOG idea
			if = {
				limit = {
					FROM = {
						OR = {
							tag = LEP
							tag = QIE
						}
					}
				}
				GEA = { country_event = Ostasien.210 }
			}

			# Japan notified that FNG has fallen
			if = {
				limit = { FROM = { tag = FNG } }
				JAP = { country_event = { id = fengtian.136 hours = 8 } }
			}

			#Clear United Front rules
			FROM = {
				if = {
					limit = { tag = event_target:china_united_front_leader }
					every_possible_country = {
						limit = { has_country_flag = was_in_united_front }
						clr_country_flag = was_in_united_front
						set_rule = { can_not_declare_war = no }
					}
					clr_country_flag = was_in_united_front
					set_rule = { can_not_declare_war = no }
					clear_global_event_target = china_united_front_leader
				}
				else_if = {
					limit = { has_country_flag = was_in_united_front }
					clr_country_flag = was_in_united_front
					set_rule = { can_not_declare_war = no }
				}
			}
		}
	}

	# ROOT is the new faction leader FROM is the old faction leader
	on_assume_faction_leadership = {
		effect = {
			if = {
				limit = { FROM = { tag = event_target:china_united_front_leader } }
				save_global_event_target_as = china_united_front_leader
			}
		}
	}

	# ROOT is capitulated country, FROM is winner
	on_capitulation_immediate = {
		effect = {
			#Remove all puppets
			if = {
				limit = {
					num_subjects > 0
					is_chinese_tag = yes
					FROM = { is_chinese_tag = yes }
				}
				every_subject_country = {
					overlord = {
						set_autonomy = {
							target = PREV
							autonomy_state = autonomy_free
						}
					}
				}
			}

			#Move the China target
			if = {
				limit = { tag = CHN }
				find_next_chinese_target = yes
			}
			#Restore Beijing VPs if QIE lost
			if = {
				limit = { tag = QIE }
				FROM = { country_event = qiefor.145 }
			}
			# Remove GEA-related ideas
			else_if = {
				limit = { tag = GEA }
				LEP = { country_event = Ostasien.213 }
				QIE = { country_event = Ostasien.213 }
				SQI = { country_event = Ostasien.213 }
				SZC = { country_event = Ostasien.213 }
			}

			# Revert Wuxi's VPs
			if = {
				limit = {
					has_global_flag = LEP_wuxi_vp_increased
					FROM = { owns_state = 613 } #Nanjing
				}
				clr_global_flag = LEP_wuxi_vp_increased
				add_victory_points = { province = 10076 value = -10 }
			}

			# logging
			if = {
				limit = { tag = QIE }
				log = "KR_Event_Logging;QIE FALLS;[GetDateText]"
			}
			else_if = {
				limit = { tag = FNG }
				log = "KR_Event_Logging;FNG FALLS;[GetDateText]"
			}
			else_if = {
				limit = { tag = YUN }
				log = "KR_Event_Logging;YUN FALLS;[GetDateText]"
			}
			else_if = {
				limit = { tag = SHX }
				log = "KR_Event_Logging;SHX FALLS;[GetDateText]"
			}
			else_if = {
				limit = { tag = SZC }
				log = "KR_Event_Logging;SZC FALLS;[GetDateText]"
			}
		}
	}

	on_civil_war_end = {
		effect = {
			if = {
				limit = { original_tag = GXC }
				country_event = lngcivilwar.13
				country_event = lngcivilwar.14
				country_event = lngcivilwar.15
				country_event = lngcivilwar.16
				country_event = lngcivilwar.20
			}
		}
	}

	#ROOT is winner #FROM gets annexed - This fires just before FROM gets annexed, meaning the country and everything it owns still exists. It will also fire on_annex and on_civil_war_end
	on_civil_war_end_before_annexation = {
		effect = {
			# GXC civil war cleanup
			if = {
				limit = { original_tag = GXC }
				remove_targeted_decision = { decision = GXC_mobilize_merchant_corps target = THIS }
				remove_targeted_decision = { decision = GXC_mobilize_gentry_militia target = THIS }
				FROM = {
					every_character = {
						limit = { has_character_flag = GXC_neutral_character }
						set_nationality = ROOT
					}
					remove_targeted_decision = { decision = GXC_mobilize_merchant_corps target = THIS }
					remove_targeted_decision = { decision = GXC_mobilize_gentry_militia target = THIS }
				}
				if = {
					limit = { GXC_has_guangdong_government = yes }
					if = {
						limit = { has_global_flag = GXC_new_guangxi_clique_took_over }
						GXC_new_guangxi_clique_flees = yes
					}
					else = {
						GXC_old_guangxi_clique_flees = yes
					}
				}
				else_if = {
					limit = { GXC_has_federalist_government = no }
					GXC_federalists_flee = yes
				}
				FROM = {
					every_subject_country = {
						limit = { has_capitulated = no }
						FROM = {
							set_autonomy = {
								target = PREV
								autonomy_state = autonomy_free
							}
						}
						white_peace = ROOT
					}
				}
			}
		}
	}

	# ROOT is country
	on_daily_QIE = {
		effect = {
			if = {
				limit = {
					has_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
				}
				QIE_recalculate_peking_commission = yes
			}
			if = {
				limit = {
					has_dynamic_modifier = { modifier = QIE_yiguandao_influence_dynamic_modifier }
				}
				QIE_recalculate_yiguandao_influence = yes
			}
		}
	}

	#FROM is war target
	on_declare_war = {
		effect = {
			# China attacking LEC
			if = {
				limit = {
					is_chinese_tag = yes
					FROM = { tag = LEC }
				}
				set_country_flag = LEC_war
				every_other_country = {
					limit = {
						OR = {
							has_subject = LEC #overlord
							is_in_faction_with = LEC #allies
							has_guaranteed = LEC #guarantors
							any_allied_country = { has_guaranteed = LEC } #allies of guarantors
						}
						NOT = { JAP = { is_ally_with = PREV } }
					}
					set_country_flag = LEC_war_backer
				}
			}

			# Chinese clique attacking United Front
			if = {
				limit = {
					is_chinese_tag = yes
					is_in_faction = no
					FROM = { is_in_faction_with = event_target:china_united_front_leader }
				}
				set_country_flag = china_refused_ceasefire
			}

			# LEC council member at war with LEC
			if = {
				limit = { FROM = { tag = LEC } }
				country_event = lec.142
			}

			# SHX getting their mounting exhaustion mission
			if = {
				limit = {
					tag = SHX
					NOT = {
						FROM = {
							owns_state = 616 #This excludes Suiyuan campaign because that has its own
							OR = {
								tag = MON
								tag = XSM
							}
						}
						has_active_mission = SHX_collapse_of_shanxi
						has_completed_focus = SHX_national_leadership
					}
				}
				activate_mission = SHX_collapse_of_shanxi
			}
		}
	}

	on_government_change = {
		effect = {
			if = {
				limit = { tag = BEL }
				if = {
					limit = { has_socialist_government = yes }
					LEC = { country_event = { id = lec.48 days = 2 } }
				}
			}
			#Move the China target
			if = {
				limit = {
					tag = CHN
					is_subject = yes
				}
				find_next_chinese_target = yes
			}
		}
	}

	on_new_term_election = {
		effect = {
			### East Turkestan ###
			if = {
				limit = { tag = ETS }
				country_event = ETS.100	#Temur
				country_event = ETS.101	#Democratic
			}
			### Qing ###
			else_if = {
				limit = { tag = QIE }
				country_event = qiecoup.32 #Sham elections... unless
				country_event = qieelection.3
				country_event = qieelection.4
			}
			### Liangguang ###
			else_if = {
				limit = { original_tag = GXC }
				country_event = lngkmt.11 #Li Zongren's RoC after political tutelage
				country_event = lngupc.30 #UPC
			}
			### Sichuan ###
			else_if = {
				limit = { tag = SZC }
				country_event = sichuan.510
				country_event = lngupc.30 #UPC
			}
			### Mongolia ###
			else_if = {
				limit = { tag = MON }
				country_event = mon.119
			}
		}
	}

	#FROM is country getting invited.
	on_offer_join_faction = {
		effect = {
			if = {
				limit = { tag = event_target:china_united_front_leader }
				FROM = {
					set_country_flag = was_in_united_front
					set_rule = { can_not_declare_war = no }
				}
			}
		}
	}

	on_ruling_party_change = {
		effect = {
			if = {
				limit = {
					china_is_potential_government = yes
					china_is_governorate = yes
				}
				clear_potential_national_government = yes
			}

			# Japan notified that FNG has been puppeted
			if = {
				limit = { tag = FNG }
				JAP = { country_event = { id = fengtian.136 hours = 8 } }
			}
			else_if = {
				limit = { original_tag = TAI }
				if = {
					limit = {
						OR = {
							will_have_totalist_government = yes
							will_have_syndicalist_government = yes
						}
					}
					activate_advisor = TAI_jian_ji_sic
				}
				else_if = {
					limit = {
						OR = {
							will_have_radical_socialist_government = yes
							will_have_social_democrat_government = yes
						}
					}
					activate_advisor = TAI_cai_peihuo_sic
				}
				else_if = {
					limit = {
						OR = {
							will_have_social_liberal_government = yes
							will_have_market_liberal_government = yes
						}
					}
					activate_advisor = TAI_liao_wenyi_sic
				}
				else_if = {
					limit = {
						OR = {
							will_have_social_conservative_government = yes
							will_have_authoritarian_democrat_government = yes
						}
					}
					activate_advisor = TAI_chen_fengyuan_sic
				}
				else = {
					activate_advisor = TAI_lan_gaochuan_sic
				}
			}
		}
	}

	#ROOT is winner #FROM is loser
	on_peaceconference_started = {
		effect = {
			#Did FNG have a wargoal on the owner of Beijing?
			if = {
				limit = {
					var:608.owner = { is_chinese_tag = yes }
					FNG = {
						exists = yes
						is_subject = no
						has_capitulated = no
						OR = {
							has_war_with_wargoal_against = {
								target = 608.owner
								type = annex_everything
							}
							AND = {
								has_completed_focus = FNG_Begin_the_War_of_National_Reclamation
								has_wargoal_against = {
									target = 608.owner
									type = annex_everything
								}
							}
						}
					}
				}
				var:608.owner = { save_global_event_target_as = FNG_had_wargoal_on_beijing }
			}
		}
	}

	#ROOT is winner #FROM is loser
	on_peaceconference_ended = {
		effect = {
			#Chinese United Front
			if = {
				limit = {
					OR = {
						has_country_flag = was_in_united_front
						FROM = { has_country_flag = was_in_united_front }
					}
				}
				if = {
					limit = { country_exists = event_target:china_united_front_leader }
					event_target:china_united_front_leader = { country_event = { id = china_events.23 days = 1 random_days = 3 } }
				}
				else_if = {
					limit = { has_event_target = china_united_front_leader }
					every_possible_country = {
						limit = { has_country_flag = was_in_united_front }
						clr_country_flag = was_in_united_front
						set_rule = { can_not_declare_war = no }
					}
					clear_global_event_target = china_united_front_leader
				}
				else = {
					clr_country_flag = was_in_united_front
					set_rule = { can_not_declare_war = no }
				}
			}

			#Give FNG a wargoal on the new owner of Beijing if they were at war
			if = {
				limit = {
					has_event_target = FNG_had_wargoal_on_beijing
					event_target:FNG_had_wargoal_on_beijing = { NOT = { owns_state = 608 } }
					var:608.owner = { is_chinese_tag = yes }
					FNG = { can_declare_war_on = 608.owner }
				}
				clear_global_event_target = FNG_had_wargoal_on_beijing
				FNG = {
					if = {
						limit = { var:608.owner = { is_ai = no } }
						set_country_flag = { flag = FNG_beijing_war_declaration_cooldown days = 40 value = 1 }
					}
					create_wargoal = {
						target = 608.owner
						type = annex_everything
					}
				}
			}

			#Legation Concession Ask
			if = {
				limit = {
					tag = LEC
					NOT = { has_country_flag = LEC_asking_for_concessions }
				}
				set_country_flag = { flag = LEC_asking_for_concessions days = 24 value = 1 }
				country_event = { id = lec.126 days = 12 }
			}

			# Legation Cities conquest legitimacy increase (FNG)
			if = {
				limit = {
					LEC = {
						exists = no
					}
					ROOT = {
						tag = FNG
						owns_state = 743
					}
				}
				ROOT = {
					country_event = { id = fengtian.322 days = 2 }
				}
			}
			# Qingdao Cities conquest legitimacy increase (FNG)
			if = {
				limit = {
					ROOT = {
						tag = FNG
						owns_state = 744
					}
				}
				ROOT = {
					country_event = { id = fengtian.323 days = 2 }
				}
			}
			# Macau conquest legitimacy increase (FNG)
			if = {
				limit = {
					ROOT = {
						tag = FNG
						owns_state = 729
					}
				}
				ROOT = {
					country_event = { id = fengtian.324 days = 2 }
				}
			}
			# Sichuan events
			if = {
				limit = {
					tag = SZC
					FROM = { tag = QIE }
				}
				ROOT = { country_event = sichuan.277 }
			}

			if = {
				limit = {
					has_country_flag = NPA_revolt
					FROM = { has_country_flag = NPA_revolt }
				}
				country_event = { id = npa.14 days = 1 }
			}

			# Completes FNG unification conference faction-joining when intra-faction wars end
			if = {
				limit = {
					has_country_flag = FNG_warring_unifconference_member
					FNG = {
						is_subject = no
					}
					is_subject = no
					NOT = {
						any_enemy_country = {
							is_in_array = { FNG.FNG_conference_support = THIS }
						}
					}
				}
				clr_country_flag = FNG_warring_unifconference_member
				country_event = { id = fngconf.82 hours = 3 random_hours = 24 }
			}

			#Restore Beijing VPs if QIE won
			if = {
				limit = { tag = QIE }
				country_event = qiefor.146
			}

			# Right KMT GXC getting YUN KMT generals
			if = {
				limit = {
					china_is_aligned_with_kmt = yes
					FROM = {
						original_tag = YUN
						exists = no #== was annexed
					}
				}
				country_event = { id = lngkmt.23 days = 2 }
			}

			### LEP war system events
			country_event = lepcollapse.26
			country_event = lepcollapse.27
			country_event = lepcollapse.28
			country_event = lepcollapse.29

			### Sets a flag for LEP beating CHI, for ANQ events (located in the FNG event file).
			if = {
				limit = {
					tag = LEP
					FROM = {
						tag = CHI
					}
				}
				ANQ = {
					set_country_flag = ANQ_lep_beat_chi #This flag was unset by the original designer, hopefully it's now working as intended.
				}
			}

			if = {
				limit = {
					OR = {
						tag = XSM
						FROM = { tag = XSM }
					}
					has_global_flag = northwest_conflict_begun
					NOT = {
						has_global_flag = northwest_conflict_ended
						TIB = { has_war_with = XSM }
						MON = { has_war_with = XSM }
					}
				}
				set_global_flag = northwest_conflict_ended
				TIB = { country_event = { id = tib.2 days = 370 } }
				XSM = { country_event = { id = mac.208 days = 3 } }
			}
		}
	}

	#ROOT is new controller #FROM is old controller #FROM.FROM is state ID
	on_state_control_changed = {
		effect = {
			if = { #Remove FNG Mantetsu Monopoly modifier
				limit = {
					NOT = { tag = FNG }
					FROM.FROM = { has_dynamic_modifier = { modifier = FNG_mantetsu_monopoly } }
				}
				FROM.FROM = {
					set_state_flag = FNG_monopoly
					remove_dynamic_modifier = { modifier = FNG_mantetsu_monopoly }
				}
			}
			if = { #Dihua and Aksu fall during Xinjiang war
				limit = {
					FROM = {
						tag = SIK
						has_idea = SIK_enemies_all_sides
						NOT = {
							controls_province = 4709
							controls_province = 4682
						}
					}
					FROM.FROM = { state = 617 }
				}
				FROM = {
					force_capitulate = yes
				}
			}
			# SZC-TIB peace deal
			if = {
				limit = {
					OR = {
						tag = TIB
						tag = SZC
					}
					has_war_with = FROM
					FROM = {
						OR = {
							tag = TIB
							tag = SZC
						}
					}
				}
				FROM = { country_event = sichuan.13 }
			}

			# Recalculate GEA AOG bonus
			if = {
				limit = {
					FROM.FROM = {
						OR = {
							state = 592
							state = 802
							state = 803
							state = 1075
						}
					}
				}
				if = {
					limit = {
						OR = {
							tag = LEP
							tag = GEA
							AND = {
								tag = QIE
								has_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
							}
						}
						FROM = {
							NOT = {
								tag = LEP
								tag = GEA
								AND = {
									tag = QIE
									has_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
								}
							}
						}
					}
					GEA = {
						subtract_from_variable = { GEA_AOG_CITIES = 0.03 }
						add_to_variable = { GEA_AOG_CITIES_NUMBER = 1 }
					}
				}
				else_if = {
					limit = {
						NOT = {
							tag = LEP
							tag = GEA
							AND = {
								tag = QIE
								has_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
							}
						}
						FROM = {
							OR = {
								tag = LEP
								tag = GEA
								AND = {
									tag = QIE
									has_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
								}
							}
						}
					}
					GEA = {
						add_to_variable = { GEA_AOG_CITIES = 0.03 }
						subtract_from_variable = { GEA_AOG_CITIES_number = 1 }
					}
				}
			}

			# Zhili Remnant events
			if = {
				limit = {
					has_war_with = QIE
					OR = {
						has_completed_focus = SZC_The_Zhilis_Last_Stand
						AND = {
							is_in_faction = yes
							faction_leader = { has_completed_focus = SZC_The_Zhilis_Last_Stand }
						}
					}
				}
				if = {
					limit = { FROM.FROM = { state = 607 } } #Luoyang
					country_event = { id = sichuan.274 hours = 8 random_hours = 16 }
				}
				else_if = {
					limit = { FROM.FROM = { state = 1048 } } #Wuhan
					country_event = { id = sichuan.275 hours = 8 random_hours = 16 }
				}
				else_if = {
					limit = { FROM.FROM = { state = 608 } } #Beijing
					country_event = { id = sichuan.276 hours = 8 random_hours = 16 }
				}
			}

			# SHX-QIE Manchu Coup Central Plains War Fall of Yulin
			if = {
				limit = {
					tag = QIE
					has_idea = QIE_zhili_manchu_war_idea
					FROM.FROM = { state = 799 } #Yulin
				}
				SHX = { country_event = { id = shx_manchu.10 days = 3 } } #Give SHX a grace period to recapture it
			}

			# Fengtian events
			if = {
				limit = {
					tag = FNG
					FROM.FROM = { state = 608 }
					NOT = { has_country_flag = FNG_conference_fired }
				}
				activate_mission = FNG_Secure_Beijing
				country_event = { id = fengtian.132 days = 1 random_hours = 96 }
			}
			if = {
				limit = {
					FROM = {
						tag = FNG
						has_country_flag = FNG_conference_fired
					}
					FROM.FROM = { state = 608 }
				}
				FROM = { country_event = fngconf.32 }
			}
			if = { # Conquest of Beijing
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 608 } #Baoding
				}
				ROOT = {
					country_event = { id = fengtian.270 days = 3 } #Matters of Occupation
					country_event = { id = fengtian.272 days = 14 } #Scandal in Beijing
				}
			}
			if = { # Moving on to the North China plain
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 608 } #Baoding
				}
				ROOT = {
					country_event = { id = fengtian.271 days = 38 } #Feeding the North China Plain
				}
			}
			if = { # Capture of Baoding
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 1062 }
				}
				ROOT = {
					country_event = { id = fengtian.274 days = 9 } #Disorder at Baoding
				}
			}
			if = { # Capture of Kaifeng
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 1059 }
				}
				ROOT = {
					country_event = { id = fengtian.276 days = 2 } #Railway Chaos in Zhengzhou
				}
			}
			if = { # Capture of Heluo
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 607 }
				}
				ROOT = {
					country_event = { id = fengtian.277 days = 9 } #Bandits against Bandits
				}
			}
			if = { # Capture of Wuhan
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 1048 }
				}
				ROOT = {
					country_event = { id = fengtian.280 days = 9 } #Disorder at Baoding
				}
			}
			if = { # Capture of Cangzhou
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 1063 }
				}
				ROOT = {
					country_event = { id = fengtian.34 days = 36 random_hours = 1500 } #Red Spears in Cangzhou
				}
			}
			if = { # Capture of Daming
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 1061 }
				}
				ROOT = {
					country_event = { id = fengtian.35 days = 36 random_hours = 1500 } # Deserters Rise up in Daming
				}
			}
			if = { # Capture of Ruyang
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 1058 }
				}
				ROOT = {
					country_event = { id = fengtian.36 days = 36 random_hours = 1500 } # Warlords Resist in Ruyang
				}
			}
			if = { # Capture of Guanzhong
				limit = {
					ROOT = { tag = FNG }
					FROM.FROM = { state = 799 }
				}
				ROOT = {
					country_event = { id = fengtian.37 days = 36 random_hours = 1500 } # Bandits Sweep Guangzhong
				}
			}

			# Yunnan events
			if = {
				limit = {
					FROM.FROM = { state = 671 }
				}
				YUN = {
					country_event = { id = yun.156 days = 1 }
				}
			}

			# Fengtian events
			if = {
				limit = {
					FROM = { tag = QIE }
					FNG = {
						exists = yes
						is_ally_with = ROOT
					}
				}
				LEP = { country_event = { id = lep.200 days = 10 } }
				FNG = { country_event = { id = lep.205 hours = 6 } }
			}

			if = { #Capture of Luoyang
				limit = {
					is_chinese_tag = yes
					FROM = { original_tag = QIE }
					FROM.FROM = { state = 607 }
				}
				country_event = { id = qieflavor.28 hours = 3 }
			}

			if = { # Update Morale
				limit = {
					OR = {
						has_idea = league_collapse_ANQ
						has_idea = league_collapse_CHI
						has_idea = league_collapse_SQI
						has_idea = league_collapse_LEP
					}
				}
				set_temp_variable = { strategic_value_temp = FROM.FROM.state_strategic_value }
				set_temp_variable = { state_name_temp = FROM.FROM }
				if = {
					limit = { check_variable = { FROM.FROM.state_strategic_value > 50 } }
					set_temp_variable = { change_league_war_morale_by = 25 }
				}
				else_if = {
					limit = { check_variable = { FROM.FROM.state_strategic_value > 25 } }
					set_temp_variable = { change_league_war_morale_by = 15 }
				}
				else_if = {
					limit = { check_variable = { FROM.FROM.state_strategic_value > 10 } }
					set_temp_variable = { change_league_war_morale_by = 10 }
				}
				else = {
					set_temp_variable = { change_league_war_morale_by = 5 }
				}

				china_update_morale = yes

				ROOT = {
					set_temp_variable = { change_league_war_morale_by = PREV.change_league_war_morale_by }
					multiply_temp_variable = { change_league_war_morale_by = -1 }
					china_update_morale = yes
				}
			}
			if = {#Shanxi plan modifers - give bonuses on taken state
				limit = {
					tag = SHX
					has_variable = SHX_states_available_for_setting_plans
					FROM.FROM = { has_state_flag = SHX_war_plan_flagged_state }
				}
				FROM.FROM = { SHX_convert_flag_modifier = yes }
			}

			if = {
				limit = {
					is_in_faction_with = JAP
					FROM = {
						is_in_faction_with = event_target:china_united_front_leader
						is_faction_leader = yes
						has_war_with = ROOT
						surrender_progress > 0.85
					}
				}
				random_country = {
					limit = {
						is_in_faction_with = event_target:china_united_front_leader
						is_faction_leader = no
						is_subject = no
						surrender_progress < 0.85
						is_chinese_tag = yes
						NOT = { original_tag = SIK }
						NOT = { original_tag = KUM }
					}
					set_faction_leader = yes
				}
			}
		}
	}

	on_war = {
		effect = {
			if = {
				limit = { tag = LEC }
				country_event = { id = lec.19 days = 3 random_days = 7 }
			}
			else_if = {
				limit = { tag = FNG }
				country_event = fngsystem.15
				if = { #Cuts Prince Kan'in Kotohito's Visit short
					limit = { has_country_flag = FNG_prince_visit }
					country_event = { id = fengtian.1500 hours = 12 }
				}
				country_event = { id = fengtian.30 days = 20 } #JAP temporarily removes Mantetsu Monopoly
			}
			else_if = {
				limit = { tag = YUN }
				country_event = { id = yun.29 days = 3 } #Zhu De intervenes
			}
		}
	}

	#ROOT = attacking side
	#FROM = defending side
	#fired when two countries end up at war with each other (on_war is fired when a country goes to war against anyone and is not fired again when it enters war against another country unless it went to peace first)
	on_war_relation_added = {
		effect = {
			if = {
				limit = {
					FROM = {
						has_war_with = LEC
						is_chinese_tag = yes
					}
					OR = {
						has_subject = LEC #overlord
						is_in_faction_with = LEC #allies
						has_guaranteed = LEC #guarantors
						any_allied_country = { has_guaranteed = LEC } #allies of guarantors
					}
				}
				set_country_flag = LEC_war_backer
			}
			else_if = {
				limit = {
					has_war_with = LEC
					is_chinese_tag = yes
					FROM = {
						OR = {
							has_subject = LEC #overlord
							is_in_faction_with = LEC #allies
							has_guaranteed = LEC #guarantors
							any_allied_country = { has_guaranteed = LEC } #allies of guarantors
						}
					}
				}
				FROM = { set_country_flag = LEC_war_backer }
			}
			if = {
				limit = {
					tag = ENT
					FROM = { is_chinese_tag = yes }
				}
				FROM = { set_country_flag = CHI_war_vs_ENT }
			}
			else_if = {
				limit = {
					FROM = { tag = ENT }
					is_chinese_tag = yes
				}
				set_country_flag = CHI_war_vs_ENT
			}

			if = {
				limit = {
					has_global_flag = LEP_war
					OR = {
						tag = LEP
						FROM = { tag = LEP }
					}
				}
				if = {
					limit = {
						OR = {
							tag = CHI
							FROM = { tag = CHI }
						}
					}
					LEP = { activate_mission = LEP_jiangxi_governor }
				}
				else_if = {
					limit = {
						OR = {
							tag = SQI
							FROM = { tag = SQI }
						}
					}
					LEP = { activate_mission = LEP_jiangsu_governor }
				}
			}
			if = {
				limit = {
					NOT = { has_global_flag = FNG_zhifeng_war_happened }
					OR = {
						tag = FNG
						tag = 608.owner
					}
					FROM = {
						OR = {
							tag = FNG
							tag = 608.owner
						}
					}
					OR = {
						is_subject = no
						FROM = { is_subject = no }
					}
				}
				set_global_flag = FNG_zhifeng_war_happened
				set_variable = { global.FNG_zhifeng_target = 608.owner }
				log = "KR_Event_Logging;FNG-QIE WAR START;[GetDateText]"
				news_event = { id = worldnews.233 hours = 6 }
				FNG = {
					remove_targeted_decision = { decision = FNG_Denounce_Qing_Monarchism target = QIE }
					remove_targeted_decision = { decision = FNG_Denounce_German_Imperialism target = GER }
					remove_targeted_decision = { decision = FNG_National_Irredentism target = THIS }
					remove_targeted_decision = { decision = FNG_Wu_Wang_Zai_Ju target = THIS }
					remove_targeted_decision = { decision = FNG_Escalate_the_Propaganda_War target = THIS }
					remove_targeted_decision = { decision = FNG_The_Yanshan_Plan target = THIS }
					remove_targeted_decision = { decision = FNG_Shanhaiguan_Infiltration target = THIS }
					country_event = fengtian.102
					if = {
						limit = { NOT = { has_completed_focus = FNG_Begin_the_War_of_National_Reclamation } }
						FNG_zhifeng_war_threat = yes
					}
				}
			}
			if = {
				limit = {
					OR = {
						tag = QIE
						tag = ANQ
					}
					FROM = {
						OR = {
							tag = QIE
							tag = ANQ
						}
					}
				}
				ANQ = {
					# Remove decisions
					remove_targeted_decision = { target = QIE decision = ANQ_reduce_qie_influence }
					remove_targeted_decision = { target = QIE decision = ANQ_closer_qie_cooperation }
					remove_targeted_decision = { target = QIE decision = ANQ_coordinated_qie_industrialisation }
					remove_targeted_decision = { target = QIE decision = ANQ_placate_qing }
					remove_targeted_decision = { target = QIE decision = ANQ_join_QIE_alliance }
					remove_targeted_decision = { target = FNG decision = ANQ_join_war_vs_FNG_self }
					# Remove national spirits
					ANQ_remove_beijing_spirit = yes
					# reduce QIE influence popularity
					set_political_party = {
						ideology = market_liberal
						popularity = 0
					}
				}
			}

			# Fengtian vs Japan
			if = {
				limit = {
					ROOT = {
						OR = {
							tag = JAP
							tag = FNG
						}
					}
					FROM = {
						OR = {
							AND = {
								country_exists = JAP
								is_ally_with = JAP
							}
							AND = {
								country_exists = FNG
								is_ally_with = FNG
							}
						}
					}
					FNG_JAP_hostile = no
				}
				FNG_break_with_japan = yes
			}

			# Fengtian + KMT vs Qing
			if = {
				limit = {
					OR = {
						AND = {
							tag = QIE
							FROM = {
								OR = {
									tag = CHI
									tag = FNG
								}
							}
						}
					}
					OR = {
						AND = {
							FROM = { tag = QIE }
							OR = {
								tag = CHI
								tag = FNG
							}
						}
					}
				}
			}

			if = {
				limit = {
					OR = {
						tag = JAP
						tag = ANQ
					}
					FROM = {
						OR = {
							tag = JAP
							tag = ANQ
						}
					}
				}
				ANQ = { ANQ_break_relations_japan = yes }
			}
			if = {
				limit = {
					OR = {
						tag = FNG
						tag = ANQ
					}
					FROM = {
						OR = {
							tag = FNG
							tag = ANQ
						}
					}
				}
				ANQ = { ANQ_break_relations_fengtian = yes }
			}
			#Setup the Shanxi plan modifer on enemy states
			if = {
				limit = {
					tag = SHX
					has_variable = SHX_states_available_for_setting_plans
				}
				SHX_add_flag_modifier = yes
			}
			else_if = {
				limit = {
					FROM = {
						tag = SHX
						has_variable = SHX_states_available_for_setting_plans
					}
				}
				FROM = { SHX_add_flag_modifier = yes }
			}
			### Shanxi Wang Xiang deposed
			if = {
				limit = {
					OR = {
						ROOT = {
							original_tag = SHX
							has_war_with = QIE
							SHX_wang_xiang = { is_second_in_command = yes }
						}
						FROM = {
							original_tag = SHX
							has_war_with = QIE
							SHX_wang_xiang = { is_second_in_command = yes }
						}
					}
				}
				SHX = { deactivate_advisor = SHX_wang_xiang_sic }
			}
		}
	}

	on_peace = {
		effect = {
			clr_country_flag = LEC_war_backer
			if = {
				limit = { tag = FNG }
				country_event = { id = fengtian.31 days = 20 }  #Re-applies FNG_mantetsu_monopoly
			}
			else_if = {
				limit = { tag = SIK }
				if = {
					limit = { has_idea = SIK_enemies_all_sides }
					remove_ideas = SIK_enemies_all_sides
				}
			}
			else_if = {
				limit = { tag = QIE }
				country_event = { id = shx_zhifeng.18 days = 2 } #Return Eastern Shanxi (615) to SHX after QIE victory
			}
			if = {
				limit = { tag = NPA }
				country_event = { id = npa.8 days = 2 random_days = 7 }
			}

			country_event = { id = lngupc.111 hours = 8 } #Country joins the UPC after finishing its wars
			if = {#remove shanxi plan modifiers if the war ended
				limit = {
					tag = SHX
					has_variable = SHX_states_available_for_setting_plans
				}
				SHX_remove_flag_modifier = yes
			}
		}
	}
}

